<?php

header('Content-Type: text/html; charset=utf-8');

// public_html/dashboard.php
if (session_status() === PHP_SESSION_NONE) { session_start(); }
if (!isset($_SESSION['user_id'])) { header("Location: login.php"); exit(); }



require_once __DIR__ . '/vendor/autoload.php';
require_once __DIR__ . '/db_connect.php';
require_once __DIR__ . '/src/Core/functions.php';

use App\Models\User;
use App\Models\Transaction;
use App\Models\OtpMessage;

$user = null;
$recentTransactions = [];
$pendingSellerOtpCount = 0;
$deliveredBuyerOtpCount = 0;

try {
    $pdo = db_connect();
    $userModel = new User($pdo);
    $user = $userModel->findById($_SESSION['user_id']);
    if (!$user) { session_destroy(); header("Location: login.php"); exit(); }

    $transactionModel = new Transaction($pdo);
    // keep as original fetching count (8) per your preference to keep logic unchanged
    $recentTransactions = $transactionModel->getRecentTransactionsByUserId($user['id'], 8);

    $otpMessageModel = new OtpMessage($pdo);
    $deliveredBuyerOtpCount = $otpMessageModel->countDeliveredRequestsForBuyer($user['id']);
    if ($user['role'] === 'seller' || $user['is_admin']) {
        $pendingSellerOtpCount = $otpMessageModel->countPendingRequestsForSeller($user['id']);
    }

} catch (\Exception $e) {
    error_log("Dashboard Page Error: " . $e->getMessage());
    die("A temporary error occurred. Please try refreshing the page.");
}

$pageTitle = "Dashboard";
$theme = $_SESSION['theme'] ?? 'light';
?>
<!DOCTYPE html>
<html lang="en" data-theme="<?= $theme ?>">
<head>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title><?= htmlspecialchars($pageTitle) ?> | SmartDigits</title>
<link rel="manifest" href="/manifest.json">

<link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root {
  --primary: #002CED;
  --secondary: #000051;
  --accent: #f97316;
  --success: #10b981;
  --danger: #ef4444;
  --light-bg: #f9fafb;
  --dark-bg: #0f172a;
  --card-light: #ffffff;
  --card-dark: #1e293b;
  --text-light: #111827;
  --text-dark: #f9fafb;
  --muted: #6b7280;
  --radius: 14px;
  --shadow: 0 6px 20px rgba(0,0,0,0.08);
  --transition: all 0.3s ease;
  --team: #000;
  font-family: 'Montserrat', sans-serif;
}

[data-theme="dark"] {
  --light-bg: var(--dark-bg);
  --card-light: var(--card-dark);
  --text-light: var(--text-dark);
  --team: #fff;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  background: var(--light-bg);
  color: var(--text-light);
  transition: var(--transition);
}

.main-content {
  max-width: 1200px;
  margin: 25px auto;
  padding: 0 20px 80px; /* bottom space for possible floating UI */
}

/* -----------------------
   HEADER (KEPT EXACT)
   ----------------------- */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
}
.header-left {
  display: flex;
  align-items: center;
  gap: 12px;
}
.profile {
  width: 45px;
  height: 45px;
  border-radius: 10px;
  overflow: hidden;
  border: 1px solid rgba(0,0,0,0.05);
}
.profile img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.header-left h4 {
  margin: 0;
  font-weight: 700;
  font-size: 16px;
}
.header-left .sub {
  color: var(--muted);
  font-size: 13px;
  margin-top: 3px;
}
.theme-toggle {
  padding: 8px 14px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  font-weight: 600;
  background: var(--card-light);
  box-shadow: var(--shadow);
  color: var(--team);
  display: flex;
  align-items: center;
  gap: 6px;
  transition: var(--transition);
}

/* -----------------------
   WALLET CARD (KEPT EXACT)
   ----------------------- */
.wallet-card {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: #fff;
  padding: 22px 25px;
  border-radius: 16px;
  box-shadow: var(--shadow);
  margin-bottom: 25px;
}
.wallet-left {
  display: flex;
  align-items: center;
  gap: 16px;
}
.wallet-icon {
  width: 60px;
  height: 60px;
  border-radius: 12px;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 26px;
  background: rgba(255,255,255,0.15);
}
.wallet-info h3 {
  margin: 0;
  font-size: 14px;
  font-weight: 700;
}
.wallet-info .amount {
  font-size: 28px;
  font-weight: 800;
  margin-top: 5px;
}
.wallet-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}
.wallet-actions a {
  text-decoration: none;
  padding: 10px 16px;
  border-radius: 10px;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 6px;
  background: #fff;
  color: var(--primary);
  transition: transform 0.2s;
}
.wallet-actions a.outline {
  background: transparent;
  border: 1px solid rgba(255,255,255,0.3);
  color: #fff;
}

/* -----------------------
   SERVICES (REPLACED)
   - uses original items/icons only
   - consolidated into a single Services section
   ----------------------- */
.services {
  margin-top: 20px;
}
.services h3 {
  margin: 0 0 12px;
  font-size: 16px;
  font-weight: 700;
}
.services-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
}
.service-card {
  background: var(--card-light);
  border-radius: 12px;
  padding: 16px;
  text-align: center;
  color: var(--text-light);
  text-decoration: none;
  box-shadow: 0 6px 20px rgba(2,6,23,0.03);
  transition: transform 0.12s;
  display:flex;
  flex-direction:column;
  gap:10px;
  align-items:center;
  justify-content:center;
}
.service-card:hover { transform: translateY(-4px); }
.service-icon {
  width:56px;
  height:56px;
  border-radius:999px;
  display:flex;
  align-items:center;
  justify-content:center;
  background: rgba(255,255,255,0.03);
  color: var(--primary);
  font-size:20px;
}
.service-card small {
  font-weight:600;
  color:var(--muted);
}

/* -----------------------
   RECENT ACTIVITIES (max 3)
   ----------------------- */
.recent-head {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-top:18px;
  margin-bottom:8px;
}
.recent-head strong { font-size:16px; }
.recent-list {
  display:flex;
  flex-direction:column;
  gap:12px;
}
.tx {
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  background:var(--card-light);
  border-radius:12px;
  padding:12px;
  box-shadow: 0 6px 20px rgba(2,6,23,0.03);
}
.tx-left { display:flex; gap:12px; align-items:center; }
.tx-icon {
  width:44px; height:44px; border-radius:10px; display:flex; align-items:center; justify-content:center;
  background:linear-gradient(180deg,#f3f4ff,#efeaff);
  font-size:18px;
  color:var(--primary);
}
.tx-meta h6{ margin:0; font-size:15px; font-weight:700; }
.tx-meta small{ color:var(--muted); display:block; margin-top:4px; font-size:13px; }

/* status badge */
.badge {
  display:inline-block;
  padding:6px 9px;
  border-radius:999px;
  font-size:12px;
  font-weight:700;
}
.badge.success{ background:rgba(16,185,129,0.12); color:var(--success); }
.badge.failed{ background:rgba(239,68,68,0.08); color:var(--danger); }

/* Responsive */
@media(max-width:900px){
  .services-grid { grid-template-columns: repeat(4, 1fr); }
}
@media(max-width:600px){
  .services-grid { grid-template-columns: repeat(4, 1fr); gap:8px; }
}
</style>
</head>
<body data-theme="<?= $theme ?>">

<div class="main-content">

  <!-- HEADER (KEPT EXACT - DO NOT EDIT) -->
  <div class="header">
    <div class="header-left">
      <div class="profile"><img src="https://i.ibb.co/Kx9CrxBM/ava.jpg" alt="Profile"></div>
      <div>
        <h4>Welcome, <?= htmlspecialchars($user['username']) ?></h4>
        <div class="sub">Your SmartDigits Dashboard</div>
      </div>
    </div>
    <button class="theme-toggle" id="themeToggle">
      <?= $theme === 'light' ? '<i class="fa fa-moon"></i> Dark' : '<i class="fa fa-sun"></i> Light' ?>
    </button>
  </div>

  <!-- WALLET CARD (KEPT EXACT - DO NOT EDIT) -->
  <div class="wallet-card fade-in-up">
    <div class="wallet-left">
      <div class="wallet-icon">
        <i class="fa fa-wallet"></i>
      </div>
      <div class="wallet-info">
        <h3>Wallet Balance</h3>
        <div class="amount">₦<?= number_format($user['wallet_balance'],2) ?></div>
      </div>
    </div>
    <div class="wallet-actions">
      <a href="fund_wallet.php"><i class="fa fa-plus-circle"></i> Fund Wallet</a>
      <a href="transaction_history.php" class="outline"><i class="fa fa-clock"></i> History</a>
    </div>
  </div>

  <!-- SERVICES: using only original items/icons from your pasted file -->
  <div class="services">
    <h3>Services</h3>
    <div class="services-grid">
      <!-- Quick actions from original file -->
      <a href="buy_number.php" class="service-card">
        <div class="service-icon"><i class="fa fa-phone"></i></div>
        <small>Virtual Number</small>
      </a>

      <a href="smm_services.php" class="service-card">
        <div class="service-icon"><i class="fa fa-rocket"></i></div>
        <small>Boost Account</small>
      </a>

      <a href="feature_unavailable.php" class="service-card coming-soon">
        <div class="service-icon"><i class="fa fa-sim-card"></i></div>
        <small>Purchase eSIM</small>
      </a>

      <!-- More items from original "More Features" moved here (exact icons/text preserved) -->
      <a href="order_history.php" class="service-card">
        <div class="service-icon"><i class="fa fa-chart-simple"></i></div>
        <small>Number Orders</small>
      </a>

      <a href="referr_earn.php" class="service-card">
        <div class="service-icon"><i class="fa fa-user-friends"></i></div>
        <small>Refer & Earn</small>
      </a>

      <a href="tutorials.php" class="service-card">
        <div class="service-icon"><i class="fa fa-tv"></i></div>
        <small>Watch Tutorials</small>
      </a>

      <a href="smm_order_history.php" class="service-card">
        <div class="service-icon"><i class="fa fa-star"></i></div>
        <small>Boosting Orders</small>
      </a>

      <a href="faq.php" class="service-card">
        <div class="service-icon"><i class="fa-solid fa-circle-question"></i></div>
        <small>FAQ</small>
      </a>

      <a href="support.php" class="service-card">
        <div class="service-icon"><i class="fa fa-headset"></i></div>
        <small>Support</small>
      </a>

      <?php if ($user['is_admin']): ?>
      <a href="admin/index.php" class="service-card">
        <div class="service-icon"><i class="fa fa-shield"></i></div>
        <small>Admin Panel</small>
      </a>
      <?php endif; ?>
    </div>
  </div>

  <!-- RECENT ACTIVITIES: show at most 3 items (keeps original fetch logic) -->
  <div class="recent-head">
    <strong>Recent Activities</strong>
    <a href="transaction_history.php" class="sub muted" style="font-size:13px;">View all</a>
  </div>

  <div class="recent-list" aria-live="polite">
    <?php
      if (empty($recentTransactions)) {
    ?>
      <div class="tx">
        <div class="tx-left">
          <div class="tx-icon"><i class="fa fa-clock"></i></div>
          <div class="tx-meta">
            <h6>No recent transactions</h6>
            <small class="muted">You have not made any transactions yet.</small>
          </div>
        </div>
        <div style="text-align:right;">
          <span class="muted">—</span>
        </div>
      </div>
    <?php
      } else {
        // render up to 3 recent transactions (do not change how $recentTransactions is fetched)
        $count = 0;
        foreach ($recentTransactions as $tx) {
          if ($count >= 3) break;
          $count++;
          $icon = 'fa-exchange-alt';
          $label = htmlspecialchars($tx['type'] ?? 'Transaction');
          if (stripos($tx['type'] ?? '', 'data') !== false) { $icon = 'fa-wifi'; }
          if (stripos($tx['type'] ?? '', 'airtime') !== false) { $icon = 'fa-phone'; }
          if (stripos($tx['type'] ?? '', 'electric') !== false) { $icon = 'fa-plug'; }
          $status = strtolower($tx['status'] ?? 'success');
          $statusClass = $status === 'success' ? 'success' : ($status === 'failed' ? 'failed' : 'success');
    ?>
      <div class="tx">
        <div class="tx-left">
          <div class="tx-icon"><i class="fa <?= $icon ?>"></i></div>
          <div class="tx-meta">
            <h6><?= $label ?></h6>
            <small class="muted"><?= date('l, M j, Y', strtotime($tx['created_at'] ?? $tx['date'] ?? 'now')) ?></small>
          </div>
        </div>

        <div style="text-align:right;">
          <div style="font-weight:800; font-size:15px;">₦<?= number_format($tx['amount'] ?? 0, 2) ?></div>
          <div class="badge <?= $statusClass ?>"><?= ucfirst($status) ?></div>
        </div>
      </div>
    <?php
        } // endforeach
      } // endif
    ?>
  </div>

</div>

<!-- Wallet Funded Modal (if any) - kept but not changed -->
<?php if (!empty($user['wallet_alert'])): ?>
<div id="walletOverlay" style="position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(2,6,23,0.4); z-index:1200;">
  <div style="width:92%; max-width:380px; background:var(--card-light); border-radius:18px; padding:18px; box-shadow:0 12px 30px rgba(2,6,23,0.06); text-align:center;">
    <div style="width:64px;height:64px;margin:0 auto;border-radius:14px;background:linear-gradient(180deg,#eef2ff,#f8f5ff);display:flex;align-items:center;justify-content:center;">
      <i class="fa fa-bell" style="font-size:26px;color:var(--secondary)"></i>
    </div>
    <h3 style="margin:14px 0 6px;">Wallet Funded</h3>
    <p style="color:var(--muted); margin:0 0 14px;"><?= htmlspecialchars($user['wallet_alert']) ?></p>
    <div style="display:flex; gap:8px;">
      <button id="closeAlert" style="flex:1;padding:10px;border-radius:12px;border:none;background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;font-weight:700;">Okay</button>
      <button id="dismissAlert" style="flex:0;padding:10px 12px;border-radius:12px;border:1px solid #e6e9ef;background:transparent;">Close</button>
    </div>
  </div>
</div>

<?php
// Clear after showing once
try {
  $pdo->prepare("UPDATE users SET wallet_alert = NULL WHERE id = ?")->execute([$user['id']]);
} catch (\Exception $e) { /* ignore */ }
?>
<?php endif; ?>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // theme toggle kept (header button)
  const themeToggle = document.getElementById('themeToggle');
  const bodyEl = document.body;
  let savedTheme = localStorage.getItem('theme') || '<?= $theme ?>';
  bodyEl.setAttribute('data-theme', savedTheme);
  if (themeToggle) {
    themeToggle.innerHTML = savedTheme === 'light' 
      ? '<i class="fa fa-moon"></i> Dark' 
      : '<i class="fa fa-sun"></i> Light';
    themeToggle.addEventListener('click', () => {
      let current = bodyEl.getAttribute('data-theme');
      let next = current === 'light' ? 'dark' : 'light';
      bodyEl.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      themeToggle.innerHTML = next === 'light' 
        ? '<i class="fa fa-moon"></i> Dark' 
        : '<i class="fa fa-sun"></i> Light';
    });
  }

  // wallet alert overlay close
  const closeAlert = document.getElementById('closeAlert');
  const dismissAlert = document.getElementById('dismissAlert');
  const overlay = document.getElementById('walletOverlay');
  if (overlay) {
    closeAlert && closeAlert.addEventListener('click', () => overlay.remove());
    dismissAlert && dismissAlert.addEventListener('click', () => overlay.remove());
  }
});
</script>

</body>
</html>
